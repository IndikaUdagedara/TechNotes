## Install
- Create bootable disk on [[Mac]]
	- Download from https://nixos.org/download/#nixos-iso
	- ```
	  diskutil list
	  
	  ```
- ## Language
-
- `let ... in ...` similar to _local variables_ - name `a` can be used in the `in` expression
  ```
  let
  	a = 1;
  in
  	a + a
  ```
- `with ...; ...` access attr set with specifying the parent
  
  ```
  with a; [ x y z ]
  ```
  is equivalent to
  ```
  [ a.x a.y a.z ]
  ```
- `inherit ..` inherit is shorthand for assigning the value of a name from an existing scope to the same name in a nested scope.
  
  ```
  let
    x = 1;
    y = 2;
  in
  {
  	inherit x y;
  }
  ```
  results in `{ x = 1; y = 2; }`
  `${ ... }`
-
- String interpoloation
	- `$x` variables in a shell script generated by a nix expr
	- Named attribute set argument for a function
	  `args@{ a, b, ... }: a + b + args.c`
	  or
	  `{ a, b, ... }@args: a + b + args.c`
- `import` is used to evaluate an expression in a file e.g., `import ./x.nix`
-
- ## Derivation
- A derivation is like an `.o` file for a `.c`. A realised derivation is like the `a.out` generated by linking `.o` files
- ### Build derivation in REPL
	- ```
	  nix-repl> :l <nixpkgs>
	  nix-repl> writeScript "test-1" ''a b c''
	  «derivation /nix/store/vmlxw3rknpaksrhqihcgkrmhq8vy9cq2-test-1.drv»
	  
	  nix-repl> drv = writeScript "test-1" ''a b c''
	  
	  nix-repl> :b drv
	  This derivation produced the following outputs:
	    out -> /nix/store/1zjmaq9dfv92kqa51ws51a2i9hpjjd4l-test-1
	  [1 built]
	  ```
- ### Example derivation
- Create `default.nix` which creates an output `sample` that contains what the `builder` produces which is just a some text `foo`
  logseq.order-list-type:: number
  ```
  derivation {
    name = "simple";
    builder = "${(import <nixpkgs> {}).bash}/bin/bash";
    args = [ "-c" "echo foo > $out" ];
    src = ./.;
    system = builtins.currentSystem;
  }
  ```
- Create derivation from `default.nix`
  logseq.order-list-type:: number
  ```
  $ nix-instantiate .
  warning: you did not specify '--add-root'; the result might be removed by the garbage collector
  /nix/store/v3bdm27d85mq33cgzav30njgzgsv79lw-simple.drv
  ```
- Realise the derivation and add to store
  logseq.order-list-type:: number
  ```
  $ nix-store -r /nix/store/v3bdm27d85mq33cgzav30njgzgsv79lw-simple.drv
  this derivation will be built:
    /nix/store/v3bdm27d85mq33cgzav30njgzgsv79lw-simple.drv
  building '/nix/store/v3bdm27d85mq33cgzav30njgzgsv79lw-simple.drv'...
  warning: you did not specify '--add-root'; the result might be removed by the garbage collector
  /nix/store/av3i3vnmkz2khbjp8qgi2296a5i3d2f9-simple
  
  $ cat /nix/store/av3i3vnmkz2khbjp8qgi2296a5i3d2f9-simple
  foo
  ```
- Above 2 steps can be combined using `nix-build`
  logseq.order-list-type:: number
  ```
  $ nix-build .
  /nix/store/av3i3vnmkz2khbjp8qgi2296a5i3d2f9-simple
  ```
-
-
- ## Flakes
- A flake is a file that contains a nix expression which can be used for multiple purposes such as
	- system configuration with `nixos-rebuild` or `darwin-rebuild`
	- create a shell environment `nix shell`
	- build a package `nix build`
- Flakes use new nix CLI `nix xxx` not `nix-xxx`
- With flakes, `NIX_PATH` becomes irrelevant as the flake defines the `nixpkgs`
- $ echo $NIX_PATH
  nixpkgs=flake:nixpkgs:/nix/var/nix/profiles/per-user/root/channels
- Minimal flake referencing another flake
	- Add other flake to registry under name `local`
		- `nix registry add local ~/Nix`
		  ```
		  {
		    inputs = {
		      # nixpkgs.url = "github:NixOS/nixpkgs/nixpkgs-24.11-darwin";
		       local.url = "local";
		       nixpkgs = {follows = "local/nixpkgs";};
		       flake-utils = {
		         url = "github:numtide/flake-utils";
		       };
		     };
		     outputs = { nixpkgs, flake-utils, ... }:
		       flake-utils.lib.eachDefaultSystem (system:
		         let
		           pkgs = import nixpkgs {
		             inherit system;
		           };
		         in
		         {
		           devShells.default = pkgs.mkShell {
		             packages = with pkgs; [
		               nodejs-18_x
		             ];
		           };
		         });
		   }
		  ```
	- Use a flake to build a package e.g., latex -> pdf
		- Create 
		  ```
		  {
		    description = "LaTeX Document Demo";
		    inputs = {
		      nixpkgs.url = github:NixOS/nixpkgs/nixos-21.05;
		      flake-utils.url = github:numtide/flake-utils;
		    };
		    outputs = { self, nixpkgs, flake-utils }:
		      with flake-utils.lib; eachSystem allSystems (system:
		      let
		        pkgs = nixpkgs.legacyPackages.${system};
		        tex = pkgs.texlive.combine {
		            inherit (pkgs.texlive) scheme-minimal latex-bin latexmk;
		        };
		      in rec {
		        packages = {
		          document = pkgs.stdenvNoCC.mkDerivation rec {
		            name = "latex-demo-document";
		            src = self;
		            buildInputs = [ pkgs.coreutils tex ];
		            phases = ["unpackPhase" "buildPhase" "installPhase"];
		            buildPhase = ''
		              export PATH="${pkgs.lib.makeBinPath buildInputs}";
		              mkdir -p .cache/texmf-var
		              env TEXMFHOME=.cache TEXMFVAR=.cache/texmf-var \
		                latexmk -interaction=nonstopmode -pdf -lualatex \
		                document.tex
		            '';
		            installPhase = ''
		              mkdir -p $out
		              cp document.pdf $out/
		            '';
		          };
		        };
		        defaultPackage = packages.document;
		      });
		  }
		  ```
		- Run `nix build`
- ## CLI
- Build package
  `nix-build -E 'with import <nixpkgs> {}; callPackage ./package.nix {}'`
- Install from nixhub
  `nix shell nixpkgs/4ae2e647537bcdbb82265469442713d066675275#azure-cli`
  `nix shell nixpkgs#poppler`
- Repair cache
  `nix-store --verify --check-contents --repair`
- Garbage collect
  `nix-collect-garbage -d`
- Find what are the deps of an executable
  `nix-store --query --tree $(which cowsay) | cat`
- Load flake to repl using `:lf`
  ```
  $ nix repl
  nix-repl> :lf ./path/to/flake/dir
  
  # e.g. 
  nix-repl> :lf ~/Nix
  nix-repl> inputs
  {
    home-manager = { ... };
    nix-darwin = { ... };
    nixpkgs = { ... };
    nixpkgs-unstable = { ... };
  }
  ```
- Load nix lib using repl
  ```
  nix-repl> :l <nixpkgs/lib>
  Added 446 variables.
  
  nix-repl> concatStringsSep ", " ["hello" "world"]
  "hello, world"
  
  ```
- Dev shell using flake
  ```
  nix develop <flake_dir>.#<shell_name>
  
  # e.g., 
  nix develop ~/Nix/.#python
  ```
-
- ## Module
- A nix module is a Nix function with five **automatically generated, automatically injected, and declaration-free parameters** provided by the module system ([reference](https://nixos-and-flakes.thiscute.world/nixos-with-flakes/nixos-flake-and-module-system)):
	- `lib`: A built-in function library included with nixpkgs, offering many practical functions for operating Nix expressions.
		- For more information, see [https://nixos.org/manual/nixpkgs/stable/#id-1.4](https://nixos.org/manual/nixpkgs/stable/#id-1.4).
	- `config`: A set of all options' values in the current environment, which will be used extensively in the subsequent section on the module system.
	- `options`: A set of all options defined in all Modules in the current environment.
	- `pkgs`: A collection containing all nixpkgs packages, along with several related utility functions.
		- At the beginner stage, you can consider its default value to be `nixpkgs.legacyPackages."${system}"`, and the value of `pkgs` can be customized through the `nixpkgs.pkgs` option.
	- `modulesPath`: A parameter available only in NixOS, which is a path pointing to [nixpkgs/nixos/modules](https://github.com/NixOS/nixpkgs/tree/nixos-24.11/nixos/modules).
- Structure of a `module` is
	- ```
	  { config, pkgs, ... }:
	  
	  {
	    imports =
	      [ # import other modules here
	      ];
	  
	    options = {
	      # ...
	    };
	  
	    config = {
	      # ...
	    };
	  }
	  ```
-
- ## References
- ### General
	- [https://jvns.ca/blog/2023/11/11/notes-on-nix-flakes/](https://jvns.ca/blog/2023/11/11/notes-on-nix-flakes/)
	- [https://github.com/evantravers/dotfiles/tree/master](https://github.com/evantravers/dotfiles/tree/master)
	- [https://gist.github.com/jmatsushita/5c50ef14b4b96cb24ae5268dab613050](https://gist.github.com/jmatsushita/5c50ef14b4b96cb24ae5268dab613050)
- ### Flakes
	- https://nixos-and-flakes.thiscute.world/best-practices/nix-path-and-flake-registry
		- [https://www.tweag.io/blog/2020-05-25-flakes/](https://www.tweag.io/blog/2020-05-25-flakes/)
- ### Packaging
	- [https://dee.underscore.world/blog/home-manager-fonts/](https://dee.underscore.world/blog/home-manager-fonts/)
- ### Modules
	- [https://xeiaso.net/talks/asg-2023-nixos/](https://xeiaso.net/talks/asg-2023-nixos/)
	- https://fasterthanli.me/series/building-a-rust-service-with-nix/part-9